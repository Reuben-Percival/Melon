name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  workflow-lint:
    name: Workflow lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint GitHub workflows
        uses: rhysd/actionlint@main

  fmt:
    name: Zig format check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-global-cache
      ZIG_LOCAL_CACHE_DIR: ${{ github.workspace }}/.zig-local-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Verify formatting
        run: |
          set -euo pipefail
          zig fmt --check build.zig src/*.zig

  shellcheck:
    name: Shell script lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fmt
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Lint scripts
        run: |
          set -euo pipefail
          bash -n install.sh uninstall.sh scripts/integration-aur.sh
          shellcheck install.sh uninstall.sh scripts/integration-aur.sh

  checks:
    name: Checks (Zig ${{ matrix.zig }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [workflow-lint, fmt, shellcheck]
    strategy:
      fail-fast: false
      matrix:
        zig: ["0.14.1", "0.15.2"]
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-global-cache
      ZIG_LOCAL_CACHE_DIR: ${{ github.workspace }}/.zig-local-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ matrix.zig }}

      - name: Cache Zig directories
        uses: actions/cache@v4
        with:
          path: |
            .zig-global-cache
            .zig-local-cache
          key: ${{ runner.os }}-zig-${{ matrix.zig }}-${{ hashFiles('build.zig', 'build.zig.zon', 'src/**', 'README.md') }}
          restore-keys: |
            ${{ runner.os }}-zig-${{ matrix.zig }}-

      - name: Build and test
        run: |
          set -euo pipefail
          echo "::group::Environment"
          zig version
          echo "::endgroup::"
          echo "::group::Build"
          zig build
          echo "::endgroup::"
          echo "::group::Unit tests"
          zig build test
          echo "::endgroup::"

  install-smoke:
    name: Install script smoke test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: checks
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-global-cache
      ZIG_LOCAL_CACHE_DIR: ${{ github.workspace }}/.zig-local-cache
      PREFIX: /tmp/melon-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build binary
        run: |
          set -euo pipefail
          zig build -Doptimize=ReleaseSafe

      - name: Install without sudo
        run: |
          set -euo pipefail
          NO_SUDO=1 SKIP_BUILD=1 PREFIX="${PREFIX}" ./install.sh

      - name: Validate installed files
        run: |
          set -euo pipefail
          test -x "${PREFIX}/bin/melon"
          "${PREFIX}/bin/melon" --version
          test -f "${PREFIX}/share/bash-completion/completions/melon"
          test -f "${PREFIX}/share/zsh/site-functions/_melon"
          test -f "${PREFIX}/share/fish/vendor_completions.d/melon.fish"

      - name: Uninstall binary
        run: |
          set -euo pipefail
          NO_SUDO=1 PREFIX="${PREFIX}" ./uninstall.sh
          test ! -e "${PREFIX}/bin/melon"
          test ! -e "${PREFIX}/share/bash-completion/completions/melon"
          test ! -e "${PREFIX}/share/zsh/site-functions/_melon"
          test ! -e "${PREFIX}/share/fish/vendor_completions.d/melon.fish"

  integration-logic:
    name: Integration logic (fixture harness)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: checks
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-global-cache
      ZIG_LOCAL_CACHE_DIR: ${{ github.workspace }}/.zig-local-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build binary
        run: |
          set -euo pipefail
          zig build -Doptimize=ReleaseSafe

      - name: Run fixture integration harness
        run: |
          set -euo pipefail
          ./scripts/integration-aur.sh

  arch-linux:
    name: Arch Linux build (pacman)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: checks
    container:
      image: archlinux:latest
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-global-cache
      ZIG_LOCAL_CACHE_DIR: ${{ github.workspace }}/.zig-local-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install toolchain
        run: |
          set -euo pipefail
          echo "::group::Pacman update"
          pacman -Syu --noconfirm --needed archlinux-keyring
          echo "::endgroup::"
          echo "::group::Install dependencies"
          pacman -S --noconfirm --needed zig git base-devel
          echo "::endgroup::"

      - name: Build and test
        run: |
          set -euo pipefail
          echo "::group::Environment"
          zig version
          uname -a
          echo "::endgroup::"
          echo "::group::Build"
          zig build
          echo "::endgroup::"
          echo "::group::Unit tests"
          zig build test
          echo "::endgroup::"
