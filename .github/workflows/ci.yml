name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  workflow-lint:
    name: Workflow Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint GitHub Workflows
        uses: rhysd/actionlint@main

  fmt:
    name: Code Hygiene
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Verify Zig Format
        run: zig fmt --check build.zig src/*.zig

  shellcheck:
    name: Script Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: fmt
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Lint Bash Scripts
        run: |
          bash -n install.sh uninstall.sh scripts/integration-aur.sh
          shellcheck install.sh uninstall.sh scripts/integration-aur.sh

  test:
    name: Build & Test (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [workflow-lint, fmt, shellcheck]
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-global-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Cache Zig Directories
        uses: actions/cache@v4
        with:
          path: .zig-global-cache
          key: ${{ runner.os }}-zig-0.15.2-${{ hashFiles('build.zig', 'build.zig.zon', 'src/**', 'README.md') }}
          restore-keys: ${{ runner.os }}-zig-0.15.2-

      - name: Environment Info
        run: zig version

      - name: Build Melon
        run: zig build

      - name: Run Unit Tests
        run: zig build test

  install-smoke:
    name: Install Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: test
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-global-cache
      PREFIX: /tmp/melon-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build Optimized Binary
        run: zig build -Doptimize=ReleaseSafe

      - name: Install (No Sudo)
        run: NO_SUDO=1 SKIP_BUILD=1 PREFIX="${PREFIX}" ./install.sh

      - name: Validate Installation
        run: |
          test -x "${PREFIX}/bin/melon"
          "${PREFIX}/bin/melon" --version
          test -f "${PREFIX}/share/bash-completion/completions/melon"
          test -f "${PREFIX}/share/zsh/site-functions/_melon"
          test -f "${PREFIX}/share/fish/vendor_completions.d/melon.fish"

      - name: Uninstall Binary
        run: |
          NO_SUDO=1 PREFIX="${PREFIX}" ./uninstall.sh
          test ! -e "${PREFIX}/bin/melon"

  integration:
    name: Integration Harness
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test
    env:
      ZIG_GLOBAL_CACHE_DIR: ${{ github.workspace }}/.zig-global-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build Optimized Binary
        run: zig build -Doptimize=ReleaseSafe

      - name: Run Fixture Integration Tests
        run: ./scripts/integration-aur.sh

  arch-linux:
    name: Arch Linux Compatibility
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test
    container:
      image: archlinux:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bootstrap Environment
        run: |
          pacman -Syu --noconfirm --needed archlinux-keyring
          pacman -S --noconfirm --needed zig git base-devel

      - name: Build & Test
        run: |
          zig version
          zig build
          zig build test
